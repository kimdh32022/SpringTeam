<!doctype html>
<html lang="ko" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" xmlns:th="www.thymeleaf.org"
      layout:decorate="~{layout/base.html}">
<head>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
</head>
<body>
<!-- content -->
<div class="container" layout:fragment="content">

    <div class="container mt-5">
        <h1>profile화면</h1>
        <div class="text-center mb-4">
            <img th:src="${users.profilePicture != null ? users.profilePicture : 'https://via.placeholder.com/150'}"
                 class="rounded-circle" alt="Profile Picture"/>
            <h2 class="mt-2" th:text="${users.name} + '님 어서오세요.'"></h2>
            <form action="/users/update" method="get">
                <input type="hidden" name="userId" th:value="${users.userId}">
                <button type="submit" class="btn btn-secondary">내 정보 수정</button>
            </form>
        </div>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addPetModal">반려견 추가</button>
        <div class="text-center mb-4">
            <h3>내 강아지</h3>

        </div>

        <div class="text-center mb-4">
            <span class="me-3">게시물 수: <strong>0</strong></span>
            <span class="me-3">팔로워 수: <strong>0</strong></span>
            <span class="me-3">팔로잉 수: <strong>0</strong></span>
        </div>

        <div class="text-center mb-4">
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#postModal">게시물 추가</button>
        </div>

        <div class="row">
            <!-- 게시물 카드가 여기에 추가됩니다. -->
        </div>
    </div>
<!--    펫 추가하기 모달-->
    <div class="modal fade" id="addPetModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addPetModalLabel">반려견 추가</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addPetForm">
                        <input type="hidden" name="userId" th:value="${users.userId}"> <!-- 유저 ID 추가 -->
                        <div class="mb-3">
                            <label for="petName" class="form-label">이름</label>
                            <input type="text" class="form-control" id="petName" required>
                        </div>
                        <div class="mb-3">
                            <label for="petType" class="form-label">종류</label>
                            <input type="text" class="form-control" id="petType" required>
                        </div>
                        <div class="mb-3">
                            <label for="petBirth" class="form-label">생년월일</label>
                            <input type="date" class="form-control" id="petBirth" required>
                        </div>
                        <div class="mb-3">
                            <label for="petGender" class="form-label">성별</label>
                            <select class="form-select" id="petGender" required>
                                <option value="">선택하세요</option>
                                <option value="male">남</option>
                                <option value="female">여</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="petPersonality" class="form-label">성격</label>
                            <input type="text" class="form-control" id="petPersonality" required>
                        </div>
                        <div class="mb-3">
                            <label for="petWeight" class="form-label">체중</label>
                            <input type="number" class="form-control" id="petWeight" required>
                        </div>
                        <button type="submit" class="btn btn-primary">추가하기</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
            crossorigin="anonymous"></script>

</div>
<!-- content -->

<!-- javascript -->
<th:block layout:fragment="javascript">
    <script>
        document.getElementById('addPetForm').addEventListener('submit', function (event) {
            event.preventDefault(); // 기본 폼 제출 방지

            const petData = {
                userId: document.querySelector('input[name="userId"]').value,
                name: document.getElementById('petName').value,
                type: document.getElementById('petType').value,
                birth: document.getElementById('petBirth').value,
                gender: document.getElementById('petGender').value,
                personality: document.getElementById('petPersonality').value,
                weight: parseFloat(document.getElementById('petWeight').value)
            };

        //     fetch('/users/pet/register', {
        //         method: 'POST',
        //         headers: {
        //             'Content-Type': 'application/json'
        //         },
        //         body: JSON.stringify(petData)
        //     })
        //         .then(response => {
        //             console.log('Response headers:', response.headers);
        //             return response.text(); // 응답 데이터를 텍스트로 읽음
        //         })
        //         .then(data => {
        //             console.log('Response body:', data); // 서버 응답 내용을 확인
        //             try {
        //                 const json = JSON.parse(data); // JSON 파싱 시도
        //                 if (json.success) {
        //                     alert(json.message); // 성공 메시지
        //                     const addPetModalElement = document.getElementById('addPetModal');
        //                     const addPetModal = bootstrap.Modal.getInstance(addPetModalElement);
        //                     addPetModal.hide();
        //                     document.getElementById('addPetForm').reset();
        //                 } else {
        //                     throw new Error(json.error || '알 수 없는 오류가 발생했습니다.');
        //                 }
        //             } catch (e) {
        //                 console.error('JSON 파싱 오류:', e);
        //                 alert('JSON 응답이 올바르지 않습니다.');
        //             }
        //         })
        //         .catch(error => {
        //             console.error('Error:', error);
        //             alert('오류가 발생했습니다: ' + error.message);
        //         });
        // })

            fetch('/users/pet/register', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(petData)
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP 오류 발생: ${response.status}`);
                    }
                    return response.json(); // JSON 응답으로 처리
                })
                .then(data => {
                    if (data.success) {
                        // 성공 메시지 처리
                        alert(data.message);

                        // 모달 닫기
                        const addPetModalElement = document.getElementById('addPetModal');
                        const addPetModal = bootstrap.Modal.getInstance(addPetModalElement); // 이미 열린 모달 가져오기
                        addPetModal.hide();

                        // 모달 백드롭을 완전히 제거 (배경 남지 않도록)
                        const backdrop = document.querySelector('.modal-backdrop');
                        if (backdrop) {
                            backdrop.remove(); // 백드롭 제거
                        }
                        // 폼 초기화
                        document.getElementById('addPetForm').reset();
                    } else {
                        // 오류 메시지 처리
                        throw new Error(data.error || '알 수 없는 오류가 발생했습니다.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('오류가 발생했습니다: ' + error.message);
                });
        });
    </script>


</th:block>
<!-- javascript -->

</body>
</html>
